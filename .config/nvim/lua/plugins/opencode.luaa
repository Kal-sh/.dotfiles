-- lua/plugins/opencode.lua: Smooth OpenCode AI integration with LazyVim

return {
  enabled = false,
  "NickvanDyke/opencode.nvim",
  dependencies = {
    { "folke/snacks.nvim", opts = { input = { enabled = true } } },
  },
  cmd = { "OpencodeAsk", "OpencodeToggle", "OpencodeExplain", "OpencodeDebug", "OpencodeReview" },
  keys = {
    -- Primary OpenCode keymaps - all use <leader>o (for OpenCode)
    { "<leader>oa", function()
      vim.bo.modifiable = true
      require("opencode").ask()
    end, desc = "OpenCode - Ask (selection/cursor)", mode = { "n", "v" } },
    
    { "<leader>ot", function() require("opencode").toggle() end, desc = "OpenCode - Toggle panel" },
    
    -- Smart selection-based actions
    { "<leader>oe", function()
      vim.bo.modifiable = true
      local mode = vim.fn.mode()
      if mode == "V" or mode == "v" or mode == "" then
        require("opencode").prompt("Explain this selected code in detail: @selection")
      else
        require("opencode").prompt("Explain the code at cursor: @cursor")
      end
    end, desc = "OpenCode - Explain code", mode = { "n", "v" } },
    
    { "<leader>or", function()
      vim.bo.modifiable = true
      local mode = vim.fn.mode()
      if mode == "V" or mode == "v" or mode == "" then
        require("opencode").prompt("Review this code for bugs and improvements: @selection")
      else
        require("opencode").prompt("Review the code at cursor for bugs and improvements: @cursor")
      end
    end, desc = "OpenCode - Review code", mode = { "n", "v" } },
    
    { "<leader>od", function()
      vim.bo.modifiable = true
      local mode = vim.fn.mode()
      if mode == "V" or mode == "v" or mode == "" then
        require("opencode").prompt("Debug this code - find issues and suggest fixes: @selection")
      else
        require("opencode").prompt("Debug the code at cursor - find issues and suggest fixes: @cursor")
      end
    end, desc = "OpenCode - Debug code", mode = { "n", "v" } },
    
    { "<leader>of", function()
      vim.bo.modifiable = true
      local mode = vim.fn.mode()
      if mode == "V" or mode == "v" or mode == "" then
        require("opencode").prompt("Refactor this code for better readability and performance: @selection")
      else
        require("opencode").prompt("Refactor the code at cursor for better readability and performance: @cursor")
      end
    end, desc = "OpenCode - Refactor code", mode = { "n", "v" } },
    
    -- Quick action shortcuts
    { "<leader>oc", function() require("opencode").command("clear") end, desc = "OpenCode - Clear conversation" },
    { "<leader>on", function() require("opencode").command("session_new") end, desc = "OpenCode - New session" },
    
    -- Navigation in OpenCode window
    { "<C-u>", function() require("opencode").command("messages_half_page_up") end, desc = "OpenCode - Scroll up", mode = "n" },
    { "<C-d>", function() require("opencode").command("messages_half_page_down") end, desc = "OpenCode - Scroll down", mode = "n" },
  },

}